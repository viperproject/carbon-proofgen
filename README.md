# Proof-Producing Fork of the Carbon Verifier
This repository contains a proof-producing instrumentation of the 
[Carbon verifier](https://github.com/viperproject/carbon) for a subset of the 
[Viper intermediate verification language](http://www.pm.inf.ethz.ch/research/viper.html).

## Installation
Clone this repository *recursively* by running:  
`git clone --recursive https://gitlab.inf.ethz.ch/gauravp/carbon-proof-generation`

### Install Dependencies
* sbt (Scala build tool): see the [main website](https://www.scala-sbt.org/) for the installation instructions
* Z3 version 4.8.7: you can get the binary from the [Z3 releases](https://github.com/Z3Prover/z3/releases/tag/z3-4.8.7)
  * make sure the folder containing the binary is included in the `PATH` environment variable (required for Boogie)
* Boogie proof generation:
  The correct version is included as a submodule in the boogie_proofgen folder.
  To install it, you need to install the .NET Core 6 SDK and then compile the project using

  ```dotnet build -c Release boogie_proofgen/Source/Boogie.sln```

  After the compilation, the corresponding executable `BoogieDriver` (for Linux and Mac) or 
  `BoogieDriver.exe` is located in `boogie_proofgen/Source/BoogieDriver/bin/Release/net6.0`.

  This Boogie executable is used for verifying the Boogie program generated by the 
  Carbon verifier. Our proof-producing instrumentation also uses the executable 
  to obtain an Isabelle embedding of the Boogie AST and to run the verification 
  on Boogie (proofs for the Boogie pipeline are not generated).

  Note that if the Boogie program does not verify, then the error messages are 
  currently meaningless, since the proof generation version removes some of the 
  error reporting features. 
  TODO: fix this for the case when the Boogie pipeline proofs are not generated

### Set Environment variables
The Carbon verifier supports command line options `--z3Exe` and `--boogieExe` to provide
explicit paths to the Z3 and Boogie executables.
If you do not want to provide those paths explicitly, then set the `Z3_EXE` and 
`BOOGIE_EXE` environment variables to point to the Z3 executable and the Boogie proof generation executable, respectively. 

### Run Tool

There are multiple alternatives:
* Alternative 1: Compile and run with sbt
  `sbt "run --genProofs --desugarPolymorphicMaps --disableAllocEncoding <path to Viper file>"`
*  Alternative 2: Compile with sbt using `sbt compile` and then use `carbon.sh` or 
   `carbon.bat` directly:

   `carbon.sh --genProofs --desugarPolymorphicMaps --disableAllocEncoding <path to Viper file`
* Alternatively, for a faster startup without compilation each time, build a `.jar` file 
using `sbt assembly` and then run directly using `java`:  

  `java -jar ./target/scala-*/carbon.jar --genProofs --desugarPolymorphicMaps --disableAllocEncoding <path to Viper file>`

Use the additional options `--z3Exe` and `--boogieExe` if you have not set up
the environment variables described above or want to provide custom versions of
Boogie or Z3.

Running the tool creates a folder with the proofs in the working directory.
There is one directory per method and one directory for the Boogie embedding.
The file `end_to_end_proof.thy` at the top level contains the full proof. An 
Isabelle ROOT session file is also generated at the top level.

### Dependencies for checking generated proofs

To check the generated proofs, you need to install Isabelle 2022 and install 
Isabelle dependencies for the Boogie formalization and the Viper total heap 
formalization. You can do so directly via the `viper-total-heaps` submodule 
by running the following commands:

`isabelle components -u viper-total-heaps/foundational_boogie/BoogieLang`

`isabelle components -u viper-total-heaps/vipersemcommon`

`isabelle components -u viper-total-heaps`

### Scripts to run tool on multiple examples

Use the following [Python script](https://gitlab.inf.ethz.ch/gauravp/proofgen_tools/-/blob/master/carbon_proofgen_scripts/generate_proofs_cpg.py) to generate proofs for all Viper examples in a folder (recursively).

Use the Python script located at `boogie_proofgen/tree/master/etc/scripts/check_proofs.py` to check all proofs in Isabelle
in a folder (recursively).
